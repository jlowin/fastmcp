# SEP-1686 Final Specification Catchup Plan

## Executive Summary

The final SEP-1686 specification has **MAJOR breaking changes** from our prototype implementation. The most critical change is that **clients no longer provide task IDs** - servers must generate them. Additionally, field names have changed (`keepAlive` ‚Üí `ttl`, `pollFrequency` ‚Üí `pollInterval`), new required fields were added (`createdAt`), the initial task status changed (`submitted` ‚Üí `working`), and the capabilities structure was refined.

---

## Critical Breaking Changes

### 1. Server-Generated Task IDs (BREAKING)

**Final Spec:**
- Clients send `task: {ttl: 60000}` in request params (NO taskId)
- Server generates taskId and returns it in `CreateTaskResult`
- Per spec line 375-377: "Task IDs **MUST** be generated by the receiver when creating a task"

**Our Implementation:**
- Clients provide `taskId` in `task: {taskId: "...", keepAlive: ...}`
- Server uses client-provided taskId
- Located in: `handlers.py:46`, `client.py` task submission code

**Impact:** Complete redesign of task creation flow required. All code that extracts `taskId` from request params must be changed to generate IDs server-side.

### 2. Field Name Changes (BREAKING)

| Old Name (Our Code) | New Name (Final Spec) | Location |
|---------------------|----------------------|----------|
| `keepAlive` | `ttl` | Task metadata, Task response |
| `pollFrequency` | `pollInterval` | Task response |

**Spec References:**
- Line 430-432: "Receivers **MUST** include a `createdAt`... **MUST** include the actual `ttl` duration"
- Line 434: "Receivers **MAY** include a `pollInterval` value"

**Our Code:**
- `protocol.py:115-116`: Uses `keepAlive` and `pollFrequency`
- `handlers.py:40`: Extracts `keepAlive` from task_meta
- `tasks.py:125-126`: Client uses `keep_alive` and `poll_frequency`

**Impact:** All field references must be renamed. Tests will fail.

### 3. New Required Field: `createdAt` (BREAKING)

**Final Spec:**
- Line 430: "Receivers **MUST** include a `createdAt` [ISO 8601](https://datatracker.ietf.org/doc/html/rfc3339#section-5)-formatted timestamp in all task responses"
- Example (line 162-163):
  ```json
  "createdAt": "2025-11-25T10:30:00Z",
  "ttl": 60000,
  ```

**Our Implementation:**
- **MISSING COMPLETELY**
- No `createdAt` field in any responses

**Impact:** Must add timestamp tracking for all tasks. Docket executions don't track creation time, may need to store separately.

### 4. Initial Task Status Changed (BREAKING)

**Final Spec:**
- Line 381: "Tasks **MUST** begin in the `working` status when created"
- Valid status values (line 591): `"submitted" | "working" | "input_required" | "completed" | "failed" | "cancelled" | "unknown"`
- `submitted` is still valid but NOT the initial state

**Our Implementation:**
- `handlers.py:105, 188, 267`: Returns `status: "submitted"` on task creation
- State machine maps Docket SCHEDULED/QUEUED to "submitted" (line 28-29)

**Impact:** Change initial status from "submitted" to "working". May need to adjust Docket state mappings.

### 5. Task Parameter Structure (BREAKING - CRITICAL)

**Final Spec (line 143-148):**
```json
{
  "method": "tools/call",
  "params": {
    "name": "get_weather",
    "arguments": {...},
    "task": {           ‚Üê Task is a PARAM, not in _meta!
      "ttl": 60000
    }
  }
}
```

**SDK Current Approach (types.py:67-92):**
```python
class RequestParams(BaseModel):
    class Meta(BaseModel):
        task: TaskMetadata | None = Field(alias=TASK_META_KEY, default=None)
        # TASK_META_KEY = "modelcontextprotocol.io/task"

    meta: Meta | None = Field(alias="_meta", default=None)
```

So SDK currently expects: `params: {name: "...", _meta: {"modelcontextprotocol.io/task": {...}}}`
But spec shows: `params: {name: "...", task: {ttl: ...}}`

**Our Current Implementation:**
- Client sends: `meta={"modelcontextprotocol.io/task": {ttl: ...}}`
- Server extracts: `task_meta = request.params.meta.get("modelcontextprotocol.io/task")`

**MAJOR CHANGE NEEDED:**
- Spec wants `task` as a top-level param alongside `name`, `arguments`
- NOT nested in `_meta`
- This affects ALL request types: CallToolRequest, GetPromptRequest, ReadResourceRequest

**Impact:**
- Need to modify how we extract task metadata from requests
- May need to extend SDK's param types to include `task` field
- Current approach via _meta is non-compliant with final spec
- This is a Phase 2 priority change

---

## Capabilities Structure Changes

### Server Capabilities

**Final Spec (lines 49-63):**
```json
{
  "capabilities": {
    "tasks": {
      "list": {},
      "cancel": {},
      "requests": {
        "tools": {
          "call": {}
        }
      }
    }
  }
}
```

**Our Implementation (`server.py:2268-2272`):**
```python
experimental_capabilities["tasks"] = {
    "tools": True,
    "prompts": True,
    "resources": True,
}
```

**Differences:**
1. Spec uses nested `requests.tools.call: {}` structure
2. Spec includes `list: {}` and `cancel: {}` at top level
3. We use flat `tools: True` instead of nested structure
4. Spec shows empty objects `{}` not booleans

**Impact:** Capability declaration needs restructuring to match spec's nested format.

### Client Capabilities

**Final Spec (lines 68-93):**
```json
{
  "capabilities": {
    "tasks": {
      "list": {},
      "cancel": {},
      "requests": {
        "sampling": {
          "createMessage": {}
        },
        "elicitation": {
          "create": {}
        }
      }
    }
  }
}
```

**Our Implementation (`_temporary_task_capability_shim.py:69-71`):**
```python
experimental={
    "tasks": {}  # Empty dict
},
```

**Impact:** Need to declare proper client capabilities structure if we want to advertise support for specific request types.

---

## Status Values and Transitions

**Final Spec Status Values (line 591):**
- `working` (initial state per line 381)
- `input_required` (NEW - for elicitation support)
- `completed`
- `failed`
- `cancelled`
- `unknown`
- **REMOVED:** `submitted` as initial state (but still valid as transition state)

**Our Status Mappings (`protocol.py:27-34`):**
```python
DOCKET_TO_MCP_STATE: dict[ExecutionState, str] = {
    ExecutionState.SCHEDULED: "submitted",  # ‚Üê Should be "working"
    ExecutionState.QUEUED: "submitted",      # ‚Üê Should be "working"
    ExecutionState.RUNNING: "working",       # ‚úì Correct
    ExecutionState.COMPLETED: "completed",   # ‚úì Correct
    ExecutionState.FAILED: "failed",         # ‚úì Correct
    ExecutionState.CANCELLED: "cancelled",   # ‚úì Correct
}
```

**Impact:** Change SCHEDULED/QUEUED mapping to "working". We don't handle `input_required` status yet (needed for elicitation support per spec lines 411-427).

---

## Task Lifecycle Requirements

### TTL and Resource Management

**Final Spec (lines 429-434):**
1. Receivers MUST include `createdAt` in all task responses
2. Receivers MAY override requested `ttl` duration
3. Receivers MUST include actual `ttl` in responses (or `null` for unlimited)
4. After TTL expires, receivers MAY delete task
5. Receivers MAY include `pollInterval` suggestion

**Our Implementation:**
- ‚úì We respect TTL via Docket's `execution_ttl`
- ‚úó We don't track `createdAt`
- ‚úó We return hardcoded values: `keepAlive: 60000`, `pollFrequency: 1000` (`protocol.py:115-116`)
- ‚úó We don't override client-requested TTL (we don't even receive it correctly!)

### Related Task Metadata

**Final Spec (lines 445-448):**
- All related messages MUST include `io.modelcontextprotocol/related-task` in `_meta`
- For `tasks/get`, `tasks/list`, `tasks/cancel`: receivers SHOULD NOT include this metadata (taskId already in response structure)
- For `tasks/result`: MUST include metadata in response

**Our Implementation:**
- ‚úì We include `modelcontextprotocol.io/related-task` in result responses
- ‚úó We include it in `tasks/get` responses (spec says SHOULD NOT - lines 447-448)
- Located in: `protocol.py:85, 99, 117, 335`

**Impact:** Remove related-task metadata from `tasks/get`, `tasks/list`, `tasks/cancel` responses.

---

## Protocol Messages Comparison

### Creating Tasks

**Final Spec Response (lines 158-168):**
```json
{
  "result": {
    "task": {
      "taskId": "786512e2-9e0d-44bd-8f29-789f320fe840",
      "status": "working",
      "statusMessage": "The operation is now in progress.",
      "createdAt": "2025-11-25T10:30:00Z",
      "ttl": 60000,
      "pollInterval": 5000
    }
  }
}
```

**Our Response (`handlers.py:100-108`):**
```python
return mcp.types.CallToolResult(
    content=[],
    _meta={
        "modelcontextprotocol.io/task": {
            "taskId": client_task_id,        # Client-provided (WRONG)
            "status": "submitted",           # Should be "working"
            # Missing: createdAt, ttl, pollInterval
        }
    },
)
```

**Differences:**
1. We embed task in `_meta`, spec shows top-level `task` field in result
2. We use client-provided taskId, spec requires server-generated
3. We use `submitted`, spec requires `working` initial status
4. We're missing `createdAt`, `ttl`, `pollInterval` fields
5. SDK's `CreateTaskResult` type may not match this structure

### Getting Task Status

**Final Spec Response (lines 209-218):**
```json
{
  "result": {
    "taskId": "...",
    "status": "working",
    "createdAt": "2025-11-25T10:30:00Z",
    "ttl": 30000,
    "pollInterval": 5000
  }
}
```

**Our Response (`protocol.py:112-131`):**
```python
response = {
    "taskId": client_task_id,
    "status": mcp_state,
    "keepAlive": 60000,        # Should be "ttl"
    "pollFrequency": 1000,     # Should be "pollInterval"
    # Missing: createdAt
    "_meta": {                 # Should NOT include related-task here
        "modelcontextprotocol.io/related-task": {
            "taskId": client_task_id,
        }
    },
}
```

**Differences:**
1. Field names wrong (`keepAlive` ‚Üí `ttl`, `pollFrequency` ‚Üí `pollInterval`)
2. Missing required `createdAt` field
3. Includes related-task metadata (spec says SHOULD NOT for tasks/get)

---

## Shims Analysis

### Current Shims

1. **`_temporary_mcp_shims.py`** (server)
   - Defines custom request types for task operations
   - Monkey-patches `ClientRequest` and `ServerRequest` unions
   - **Status:** Still needed - SDK doesn't have these types yet

2. **`_temporary_task_capability_shim.py`** (client)
   - Custom `ClientSession` that declares `experimental: {tasks: {}}`
   - **Status:** Still needed - SDK hardcodes `experimental=None`

### New Shims Needed

1. **Task Creation Response Shim**
   - **Why:** Need to translate between SDK's `CreateTaskResult` (which may not exist yet or have wrong structure) and spec's response format
   - **What:** Wrapper to generate proper `CreateTaskResult` with server-generated taskId, createdAt, ttl, pollInterval
   - **Location:** New file `src/fastmcp/server/tasks/_task_creation_shim.py`

2. **Task Metadata Translation Shim**
   - **Why:** SDK's `TaskMetadata` has `taskId` + `keepAlive`, but spec shows `ttl` only in request params
   - **What:** Extract `ttl` from request, ignore any `taskId` from client, generate new ID server-side
   - **Location:** Extend `_temporary_mcp_shims.py`

3. **Task Status Response Shim**
   - **Why:** Need to ensure all responses have correct fields (ttl not keepAlive, createdAt present)
   - **What:** Wrapper to normalize task status responses to spec format
   - **Location:** New helper in `protocol.py`

---

## Test Coverage Analysis

### Existing Tests (18 test files)

**Protocol Tests:**
- `test_task_protocol.py` - Generic protocol tests ‚úì
- `test_task_capabilities.py` - Capability declaration ‚úó (will fail due to structure changes)
- `test_task_metadata.py` - Metadata handling ‚úó (field names changed)
- `test_task_methods.py` - Operation methods ‚úì

**Component Tests:**
- `test_task_tools.py` - Tool task execution ‚úó (status/field names)
- `test_task_prompts.py` - Prompt task execution ‚úó
- `test_task_resources.py` - Resource task execution ‚úó
- `test_task_dependencies.py` - DI in task context ‚úì
- `test_task_return_types.py` - Return value conversion ‚úì

**Client Tests:**
- `test_client_tasks.py` - Client task operations ‚úó (field names)
- `test_client_tool_tasks.py` - Client tool tasks ‚úó
- `test_client_prompt_tasks.py` - Client prompt tasks ‚úó
- `test_client_resource_tasks.py` - Client resource tasks ‚úó
- `test_task_context_validation.py` - Context validation ‚úì
- `test_task_result_caching.py` - Result caching ‚úì
- `test_client_task_protocol.py` - Protocol operations ‚úó

**Other:**
- `test_task_keepalive.py` - TTL handling ‚úó (renamed to ttl)
- `test_task_security.py` - Security/isolation ‚úì
- `test_server_tasks_parameter.py` - task= parameter ‚úó
- `test_sync_function_task_disabled.py` - Sync function handling ‚úì

**Summary:** ~8-10 tests will fail due to field name changes and status changes. Most protocol tests need updates.

### Tests That Need Updates

1. **Field name assertions** - Any test checking `keepAlive`, `pollFrequency` must change to `ttl`, `pollInterval`
2. **Status assertions** - Tests expecting initial `submitted` status must expect `working`
3. **Capability structure** - Tests checking capability format need updating
4. **Task ID generation** - Tests providing custom taskIds may need adjustment
5. **Missing createdAt** - Tests validating response structure will fail without this field

### New Tests Needed

1. **Server-generated task IDs** - Verify IDs are generated, not from client
2. **createdAt timestamp** - Verify ISO 8601 format, reasonable timestamp
3. **TTL override behavior** - Test server can override client's requested TTL
4. **input_required status** - Test transition to/from this new status
5. **Capability negotiation** - Test new nested structure
6. **Related-task metadata rules** - Test it's excluded from tasks/get but included in tasks/result

---

## Implementation Priority

### Phase 1: Critical Breaking Changes (MUST DO FIRST)

1. **Task ID generation**
   - Change server to generate UUIDs instead of using client-provided IDs
   - Update `handlers.py:46, 131, 214` to generate IDs
   - Update client to not send taskId in request params
   - Files: `handlers.py`, `client.py`

2. **Field name changes**
   - Rename all `keepAlive` ‚Üí `ttl`
   - Rename all `pollFrequency` ‚Üí `pollInterval`
   - Files: `protocol.py`, `handlers.py`, `tasks.py`, `converters.py`, test files

3. **Add createdAt timestamp**
   - Store creation timestamp when task is created
   - Include in all task responses
   - Files: `handlers.py`, `protocol.py`

4. **Change initial status**
   - Change "submitted" ‚Üí "working" for new tasks
   - Update Docket state mappings
   - Files: `handlers.py`, `protocol.py`

### Phase 2: Protocol Compliance

5. **Task parameter structure**
   - Create shim to translate request `{task: {ttl: ...}}` to internal format
   - Generate taskId server-side, ignore any client-provided ID
   - Files: New shim file, `handlers.py`

6. **Capabilities structure**
   - Change flat structure to nested `requests.tools.call: {}` format
   - Add `list: {}` and `cancel: {}` top-level keys
   - Files: `server.py`, `http.py`

7. **Related-task metadata rules**
   - Remove from `tasks/get`, `tasks/list`, `tasks/cancel` responses
   - Keep in `tasks/result` responses
   - Files: `protocol.py`

### Phase 3: New Shims and Enhancement

8. **Create new shims**
   - Task creation response wrapper
   - Task metadata translation
   - Task status response normalization

9. **Update tests**
   - Fix field name assertions
   - Fix status value assertions
   - Add new tests for server-generated IDs, createdAt, etc.

10. **input_required status support**
    - Implement support for this new status
    - Add elicitation flow handling
    - Lower priority - not blocking basic functionality

---

## Risks and Concerns

### High Risk

1. **SDK Type Mismatch:** The reference SDK's `TaskMetadata` has `taskId: str` as a field, but the spec shows clients should only send `ttl` in request params. This is a fundamental mismatch that suggests either:
   - The spec changed after SDK was written
   - The SDK is for the response (CreateTaskResult) not the request
   - There's confusion in the spec itself

2. **CreateTaskResult Type Missing:** The spec mentions `CreateTaskResult` but we don't see this type clearly defined in the reference SDK types. May need to create our own.

3. **Breaking Existing Deployments:** These changes are ALL breaking - any existing clients/servers using our current implementation will fail.

### Medium Risk

1. **Timestamp Management:** Adding `createdAt` requires tracking timestamps. Docket doesn't expose creation time, may need separate storage.

2. **TTL Semantics:** Spec says "time from creation" but we're using Docket's `execution_ttl` which may have different semantics (time from submission? from completion?).

3. **Test Disruption:** ~50% of tests will need updates, risk of introducing new bugs during refactoring.

### Low Risk

1. **Capabilities Format:** Nested structure is more complex but straightforward to implement.

2. **Related-task Metadata:** Easy fix to conditionally exclude from certain responses.

---

## Session Breakdown Plan

### Session 1: Foundation and Phase 1 ‚úÖ COMPLETED
- ‚úÖ Create branch `sep-1686-final-spec`
- ‚úÖ Create this plan document
- ‚úÖ Commit plan (commit e1d2cb11)
- ‚úÖ **Implement Phase 1 changes** (commit 56e080e9)
  - Server-generated task IDs (UUID v4)
  - Field renames: `keepAlive` ‚Üí `ttl`, `pollFrequency` ‚Üí `pollInterval`
  - Added required `createdAt` timestamp (ISO 8601 format)
  - Changed initial status from "submitted" to "working"
  - Updated Docket state mappings
  - Fixed client/server incompatibility with task ID generation
  - Updated all 147 task tests
  - **Result:** All 3241 tests passing

### Session 2: Phase 2 Protocol Compliance ‚úÖ COMPLETED

#### 2.1: Task Parameter Structure (BREAKING - HIGH PRIORITY)

**Current State:**
- Client sends: `call_tool_mcp(name="...", arguments={...}, meta={"modelcontextprotocol.io/task": {ttl: ...}})`
- Server extracts: `task_meta = meta_dict.get("modelcontextprotocol.io/task")` (server.py:1227, 1350, 1472)

**Final Spec Requirement:**
- Client should send: `params: {name: "...", arguments: {...}, task: {ttl: 60000}}`
- `task` is a sibling to `name` and `arguments`, NOT in `_meta`

**SDK Draft Approach:**
- Uses `_meta: {"modelcontextprotocol.io/task": {...}}` structure
- Has `RequestParams.Meta` with aliased `task` field
- This is NOT what the final spec shows!

**Implementation Options:**

**Option A: Extend SDK param types (cleanest)**
- Extend `CallToolParams`, `GetPromptParams`, `ReadResourceParams` to include `task: TaskMetadata | None` field
- Update server extraction to look for `request.params.task` instead of `request.params.meta`
- Most spec-compliant but requires modifying SDK types

**Option B: Shim layer (safest for now)**
- Create shim that intercepts requests and moves `task` from params to _meta
- Allows SDK to stay unchanged
- Easy to remove when SDK updates

**Recommendation:** Start with Option B shim, document clearly for future SDK alignment

**Files to modify:**
- Create new shim: `src/fastmcp/server/tasks/_task_param_shim.py`
- Update extraction in `server.py:1227, 1350, 1472`
- Update client send in `client.py:807, 999, 1324`

#### 2.2: Related-Task Metadata Rules ‚úÖ COMPLETED (commit 4d1e69e1)
- ‚úÖ Removed related-task metadata from tasks/get responses (per spec lines 447-448)
- ‚úÖ Removed related-task metadata from tasks/cancel responses
- ‚úÖ Kept related-task metadata in tasks/result (required per spec)
- ‚úÖ Updated capabilities structure from flat to nested format:
  ```python
  experimental_capabilities["tasks"] = {
      "list": {},
      "cancel": {},
      "requests": {
          "tools": {"call": {}},
          "prompts": {"get": {}},
          "resources": {"read": {}},
      },
  }
  ```
- **Result:** All 3241 tests passing

### Session 3: Reconcile Shim Types with SDK Draft ‚úÖ COMPLETED

**Phase 3: SDK Type Reconciliation** (commit 3c5a0c77)
- ‚úÖ Reviewed SDK types in `/home/chris/src/github.com/modelcontextprotocol/python-sdk` (feat/tasks branch)
- ‚úÖ Identified type name and structure differences
- ‚úÖ Renamed all shim types to match SDK naming conventions:
  - `TasksGetRequest` ‚Üí `GetTaskRequest`
  - `TasksResultRequest` ‚Üí `GetTaskPayloadRequest`
  - `TasksListRequest` ‚Üí `ListTasksRequest`
  - `TasksCancelRequest` ‚Üí `CancelTaskRequest` (SDK doesn't have yet)
  - `TasksDeleteRequest` ‚Üí `DeleteTaskRequest`
- ‚úÖ Added `GetTaskResult` and `ListTasksResult` response types
- ‚úÖ Added heavy documentation explaining SDK divergences:
  - SDK uses `keepAlive` (wrong, spec requires `ttl`)
  - SDK missing `createdAt` field (required per spec line 430)
  - SDK allows "submitted" initial status (spec requires "working")
- ‚úÖ Kept our spec-compliant corrections
- ‚úÖ Updated protocol.py handlers to use new type names
- ‚úÖ Updated client.py to use new type names
- ‚úÖ Updated monkey-patch unions with new names
- **Result:** All 3241 tests passing

**Phase 3.1: Strongly-Typed Protocol Handlers** (commit 8787a262)
- ‚úÖ Updated handlers to return proper typed results instead of dicts:
  - `tasks_get_handler` ‚Üí `GetTaskResult`
  - `tasks_list_handler` ‚Üí `ListTasksResult`
  - `tasks_cancel_handler` ‚Üí `GetTaskResult`
  - `tasks_delete_handler` ‚Üí `EmptyResult`
- ‚úÖ Wrappers serialize typed results to dicts at boundary for ServerResult compatibility
- ‚úÖ Type safety in handler layer, compatibility at transport layer
- ‚úÖ Follows SDK conventions while maintaining spec compliance
- **Result:** All 3241 tests passing, 147 task tests passing

### Session 4: Phase 2.1 Decision Point ‚ö†Ô∏è DEFERRED

**Task Parameter Structure** (from Section 2.1 above) - BREAKING WIRE PROTOCOL CHANGE

**The Issue:**
- **Current implementation:** Client sends `_meta: {"modelcontextprotocol.io/task": {ttl: ...}}`
- **Final spec requirement:** Client should send `params: {name: "...", task: {ttl: 60000}}` as sibling to name/arguments
- **SDK draft approach:** Uses `_meta` structure (WRONG per final spec!)

**Why Deferred:**
1. Our current implementation WORKS and passes all 3241 tests
2. SDK draft itself is using the _meta approach (non-compliant with final spec)
3. This is a wire protocol change affecting client/server communication
4. Unclear if we should follow broken SDK draft or correct final spec

**Decision Options:**
1. **Wait for SDK fix** - Let SDK update to match spec first, then follow (safest, maintains compatibility)
2. **Follow spec now** - Implement spec-compliant version with shim for SDK (most correct, breaks SDK compatibility)
3. **Hybrid approach** - Support both formats with detection/translation layer

**Recommendation:** Wait for official SDK release that matches final spec, OR get clarification from MCP team on this discrepancy.

### Session 5: Polish and Documentation (Lower Priority)

**Potential additions:**
- `input_required` status support (for elicitation flow, spec lines 411-427)
- Additional edge case test coverage
- Documentation updates for new task protocol
- Performance testing with Docket task execution

**Validation Status:**
- ‚úÖ All 3241 tests passing
- ‚úÖ All 147 task-specific tests passing
- ‚úÖ Zero regressions from Phase 1, 2, 3 changes
- ‚úÖ Heavy comments documenting SDK divergences
- ‚úÖ Spec compliance verified (except Phase 2.1 wire format issue)

---

## Current Status (End of Session 3)

### ‚úÖ Completed
- **Phase 1:** Breaking changes (server-generated IDs, field renames, createdAt, working status)
- **Phase 2:** Protocol compliance (related-task metadata, capabilities structure)
- **Phase 3:** SDK type reconciliation with heavily documented divergences
- **Phase 3.1:** Strongly-typed protocol handlers

### ‚ö†Ô∏è Deferred (Now Priority)
- **Phase 2.1:** Task parameter structure (`_meta` ‚Üí `params.task`)

### üìä Test Status
- All 3241 tests passing
- All 147 task tests passing
- Zero regressions

### üéØ Next Steps
**Implement Phase 2.1** - Move from `_meta: {"modelcontextprotocol.io/task": ...}` to spec-compliant `params.task: {ttl: ...}` approach, favoring final spec over SDK draft.

---

## SDK Type Reconciliation Analysis

### SDK Draft vs Final Spec Comparison

**Critical Finding:** The SDK draft types (feat/tasks branch) are **NOT up to date** with the final specification. Our Phase 1 implementation is actually MORE spec-compliant than the SDK draft.

#### SDK Types Still Using Old Field Names

**TaskMetadata (SDK types.py:46-55):**
```python
class TaskMetadata(BaseModel):
    taskId: str  # ‚Üê Spec says client shouldn't send this
    keepAlive: int | None = None  # ‚Üê Spec says should be "ttl"
```

**Task / GetTaskResult (SDK types.py:585-615, 647-665):**
```python
class Task(BaseModel):
    taskId: str
    status: Literal[...]
    keepAlive: int | None  # ‚Üê Should be "ttl"
    pollInterval: int | None  # ‚úì Correct
    error: str | None
    # ‚úó Missing: createdAt (REQUIRED per spec line 430)
```

**Our Types (After Phase 1):**
```python
class TaskStatusResponse(pydantic.BaseModel):
    task_id: str = pydantic.Field(alias="taskId")
    status: Literal[...]
    created_at: str = pydantic.Field(alias="createdAt")  # ‚úì We have this
    ttl: int | None = pydantic.Field(alias="ttl")  # ‚úì Correct field name
    poll_interval: int | None = pydantic.Field(alias="pollInterval")  # ‚úì Correct
    error: str | None = None
```

**Conclusion:** Our types are MORE correct than the SDK draft. We should keep our field names.

#### SDK Has More Complete Type Coverage

**New types in SDK we should consider adopting:**

1. **Request/Response Types:**
   - `GetTaskRequest` (SDK has it, we have `TasksGetRequest` - similar)
   - `GetTaskResult` (SDK has it, we use dict responses)
   - `GetTaskPayloadRequest` (we call it `TasksResultRequest`)
   - `ListTasksRequest` (SDK has `ListTasksRequest`, we have `TasksListRequest`)
   - `CancelTaskRequest` (we have `TasksCancelRequest`)
   - `DeleteTaskRequest` (we have `TasksDeleteRequest`)

2. **Capability Types:**
   - `TasksOperationsCapability`
   - `TaskToolsCapability` / `TaskPromptsCapability` / `TaskResourcesCapability`
   - `ServerTasksRequestsCapability` / `ClientTasksRequestsCapability`
   - `ServerTasksCapability` / `ClientTasksCapability`

3. **Notification Types:**
   - `TaskCreatedNotification` (we construct manually)
   - `TaskCreatedNotificationParams`

4. **Core Types:**
   - `TaskMetadata` (for request params - though SDK version is wrong)
   - `RelatedTaskMetadata` (for related-task in _meta)

### Reconciliation Strategy

**Phase: SDK Type Alignment (New Session 3)**

1. **Adopt SDK naming conventions** where they exist:
   - Rename `TasksGetRequest` ‚Üí `GetTaskRequest` (match SDK)
   - Rename `TasksResultRequest` ‚Üí `GetTaskPayloadRequest` (match SDK)
   - Keep our field name corrections (ttl, createdAt)

2. **Add missing types from SDK:**
   - `GetTaskResult` for tasks/get response (instead of dict)
   - Capability types for proper structure
   - Notification types

3. **Document SDK divergences:**
   - Add heavy comments explaining where SDK is wrong vs spec
   - Note which fields we corrected (keepAlive ‚Üí ttl, added createdAt)
   - Track for future SDK updates

4. **DO NOT adopt SDK's incorrect fields:**
   - Keep `ttl` (not `keepAlive`)
   - Keep `createdAt` (SDK is missing it)
   - Keep `working` as initial status (SDK still has `submitted`)

### Files to Review for Reconciliation

**Our Shims:**
- `src/fastmcp/server/tasks/_temporary_mcp_shims.py`
- `src/fastmcp/client/tasks.py` (our protocol types)

**SDK Reference:**
- `/home/chris/src/github.com/modelcontextprotocol/python-sdk/src/mcp/types.py`
- Lines 46-665 (all task-related types)

---

## Questions for Resolution

1. **CreateTaskResult structure:** What is the actual type returned in response to a task-augmented request? The spec mentions it but doesn't define it clearly. Is it a wrapper around the normal result?

2. **SDK TaskMetadata:** Why does SDK have `taskId` in `TaskMetadata` if clients shouldn't send it? Is this for response-only?

3. **Docket creation timestamps:** Can we get creation time from Docket, or do we need separate storage?

4. **Migration strategy:** Do we want any backward compatibility, or clean break?

5. **input_required status:** How urgently do we need elicitation support? This is a bigger feature.

---

## Summary of Changes Required

| Category | Changes | Files Affected | Breaking | Priority |
|----------|---------|----------------|----------|----------|
| Task IDs | Server-generates, not client-provided | handlers.py, client.py, protocol.py | YES | P0 |
| Field Names | keepAlive‚Üíttl, pollFrequency‚ÜípollInterval | protocol.py, handlers.py, tasks.py, converters.py, tests | YES | P0 |
| createdAt | Add required timestamp field | handlers.py, protocol.py | YES | P0 |
| Initial Status | Change "submitted"‚Üí"working" | handlers.py, protocol.py | YES | P0 |
| Task Params | Request sends {ttl} not {taskId, keepAlive} | handlers.py, shims | YES | P1 |
| Capabilities | Nested structure, add list/cancel keys | server.py, http.py | YES | P1 |
| Metadata Rules | Exclude related-task from some responses | protocol.py | NO | P1 |
| New Shims | Creation/translation/normalization wrappers | New files | NO | P2 |
| Tests | Update assertions, add new coverage | All test files | NO | P2 |
| input_required | New status for elicitation flow | protocol.py, handlers.py | NO | P3 |

**Total Breaking Changes:** 5 major areas
**Estimated Effort:** 2-3 days for P0/P1 changes, 1-2 days for P2, P3 can be deferred
